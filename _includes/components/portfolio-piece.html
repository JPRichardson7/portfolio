<!-- Portfolio Piece Component -->
<article class="portfolio-piece">

    <!-- Title Section (Mobile Only) -->
    {% if include.title %}
        <header class="portfolio-piece-header flex items-baseline lg:hidden!">
            <div class="w-[calc(var(--spacing-margin-base)*2)] h-[.4cqw] bg-light-blue flex-shrink-0 "></div>
            <div class="flex-shrink-0 px-2">
                <h2 class="hero-text text-light-blue text-[clamp(1rem,5cqw,1.10rem)]! italic tracking-widest">
                    {{ include.title }}
                </h2>
                {% if include.subtitle %}
                    <p class="text-light-blue/80 text-[clamp(1rem,3cqw,1.5rem)] font-light">
                        {{ include.subtitle }}
                    </p>
                {% endif %}
            </div>
            <div class="flex-1 h-[.4cqw] bg-light-blue"></div>
        </header>
    {% endif %}

    <!-- Prepare carousel data before layout split -->
    {% assign has_carousel_folder = false %}
    {% if include.carousel_folder and include.carousel_folder != "" %}
        {% assign has_carousel_folder = true %}
        {% comment %} Auto-discover images from folder {% endcomment %}
        {% assign folder_path = include.carousel_folder | prepend: "/" %}
        {% assign folder_images = site.static_files | where_exp: "file", "file.path contains folder_path" | where_exp: "file", "file.extname == '.jpg' or file.extname == '.jpeg' or file.extname == '.png' or file.extname == '.gif' or file.extname == '.webp'" | sort: "name" %}

        {% comment %} Try to load metadata from _data/projects/[folder-name].yml {% endcomment %}
        {% assign folder_basename = include.carousel_folder | split: "/" | last %}
        {% assign meta_data = site.data.projects[folder_basename] %}
    {% elsif include.carousel_inline %}
        {% comment %} Parse inline format: "img1.jpg|Alt 1|img2.jpg|Alt 2" {% endcomment %}
        {% assign inline_parts = include.carousel_inline | split: '|' %}
    {% endif %}

    <!-- Determine display image early so carousel-image-generator can use it -->
    {% assign display_image = include.image %}
    {% if include.image == "" or include.image == nil %}
        {% if has_carousel_folder and folder_images.size > 0 %}
            {% assign display_image = folder_images[0].path | remove_first: "/assets/img/" | remove_first: "assets/img/" %}
        {% endif %}
    {% endif %}

    <!-- Generate pre-processed carousel images with Jekyll Picture Tag -->
    {% if include.carousel_images or include.carousel_inline or has_carousel_folder or display_image %}
        <!-- Hidden container to pre-generate optimized carousel images -->
        <div class="carousel-image-generator" style="display: none;" aria-hidden="true">
            {% assign crop_mode = include.crop_mode | default: "center" %}
            {% if has_carousel_folder %}
                {% for img in folder_images %}
                    {% assign img_path = img.path | remove_first: "/assets/img/" | remove_first: "assets/img/" %}
                    <div class="carousel-gen-img" data-index="{{ forloop.index0 }}" data-alt="{% if meta_data[img.name] %}{{ meta_data[img.name] | escape }}{% else %}{{ img.path | image_description | escape }}{% endif %}">
                        {% picture "{{ img_path }}" %}
                    </div>
                {% endfor %}
            {% elsif include.carousel_inline %}
                {% for i in (0..10) %}
                    {% assign idx = i | times: 2 %}
                    {% assign src = inline_parts[idx] %}
                    {% assign alt = inline_parts[idx | plus: 1] %}
                    {% if src and src != '' %}
                        <div class="carousel-gen-img" data-index="{{ i }}" data-alt="{{ alt | escape }}">
                            {% picture {{ src }} %}
                        </div>
                    {% endif %}
                {% endfor %}
            {% elsif include.carousel_images %}
                {% for img in include.carousel_images %}
                    <div class="carousel-gen-img" data-index="{{ forloop.index0 }}" data-alt="{{ img.alt | escape }}">
                        {% picture {{ img.src }} %}
                    </div>
                {% endfor %}
            {% elsif display_image %}
                {% comment %} Single image - generate uncropped version for mobile expansion {% endcomment %}
                <div class="carousel-gen-img" data-index="0" data-alt="{% if include.image_alt %}{{ include.image_alt | escape }}{% elsif include.title %}{{ include.title | escape }}{% endif %}">
                    {% picture {{ display_image }} %}
                </div>
            {% endif %}
        </div>
    {% endif %}

    <!-- Reusable blocks for desktop layout -->
    {% capture desktop_header %}
        {% if include.title %}
            <header class="portfolio-piece-header-desktop flex flex-col">
                <h2 class="hero-text text-light-blue text-[clamp(1.2rem,3vw,2rem)]! italic tracking-widest">
                    {{ include.title }}
                </h2>
                {% if include.subtitle %}
                    <p class="text-light-blue/80 text-[clamp(1rem,2vw,1.5rem)]! font-light">
                        {{ include.subtitle }}
                    </p>
                {% endif %}
            </header>
        {% endif %}
    {% endcapture %}

    {% capture content_block %}
        {% if include.content %}
            <div class="prose-invert max-w-none text-left sm:text-justify">
                {{ include.content | markdownify }}
            </div>
        {% endif %}
        {% if include.skills %}
            <div class="portfolio-piece-skills mt-4">
               
                <p class="ml-2"> <span class="text-light-blue hero-text uppercase">Skills:</span> {{ include.skills }}</p>
            </div>
        {% endif %}
    {% endcapture %}

    {% capture filmstrip_block %}
        {% if include.carousel_images or include.carousel_inline or has_carousel_folder %}
        {% comment %} Count images for conditional nav button display {% endcomment %}
        {% if has_carousel_folder %}
            {% assign image_count = folder_images.size %}
        {% elsif include.carousel_inline %}
            {% assign image_count = 0 %}
            {% for i in (0..10) %}
                {% assign idx = i | times: 2 %}
                {% assign src = inline_parts[idx] %}
                {% if src and src != '' %}
                    {% assign image_count = image_count | plus: 1 %}
                {% endif %}
            {% endfor %}
        {% else %}
            {% assign image_count = include.carousel_images.size %}
        {% endif %}
        <div class="filmstrip-wrapper px-10" data-image-count="{{ image_count }}">
            <button class="filmstrip-nav-btn prev" aria-label="Scroll filmstrip left">&lsaquo;</button>
            <div class="portfolio-filmstrip hidden lg:flex! gap-2 mt-4 overflow-x-auto">
                {% if has_carousel_folder %}
                    {% for img in folder_images %}
                    {% assign img_path = img.path | remove_first: "/assets/img/" | remove_first: "assets/img/" %}
                    {% if meta_data[img.name] %}
                        {% assign thumb_alt = meta_data[img.name] %}
                        {% assign thumb_caption = meta_data[img.name] %}
                    {% else %}
                        {% assign thumb_alt = "Thumbnail " | append: forloop.index %}
                        {% assign thumb_caption = nil %}
                    {% endif %}
                    <div class="filmstrip-item flex flex-col flex-shrink-0">
                        <button class="filmstrip-thumb w-30 h-30 overflow-hidden pb-1 transition-all cursor-pointer" data-index="{{ forloop.index0 }}">
                            {% picture "{{ img_path }}" --alt {{ thumb_alt }} --img class="w-full h-full object-cover" %}
                        </button>
                        {% if thumb_caption %}
                        <p class="filmstrip-caption text-light-blue/70 text-xs mt-2 max-w-[7.5rem] leading-tight">{{ thumb_caption }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% elsif include.carousel_inline %}
                    {% for i in (0..10) %}
                        {% assign idx = i | times: 2 %}
                        {% assign src = inline_parts[idx] %}
                        {% if src and src != '' %}
                        {% assign thumb_num = i | plus: 1 %}
                        {% assign thumb_alt = "Thumbnail " | append: thumb_num %}
                        <button class="filmstrip-thumb flex-shrink-0 w-20 h-16 overflow-hidden border-2 border-transparent hover:border-light-blue/50 transition-all cursor-pointer" data-index="{{ i }}">
                            {% picture "{{ src }}" --alt {{ thumb_alt }} --img class="w-full h-full object-cover" %}
                        </button>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    {% for img in include.carousel_images %}
                    <button class="filmstrip-thumb flex-shrink-0 w-20 h-16 overflow-hidden border-2 border-transparent hover:border-light-blue/50 transition-all cursor-pointer" data-index="{{ forloop.index0 }}">
                        {% picture "{{ img.src }}" --alt {{ img.alt }} --img class="w-full h-full object-cover" %}
                    </button>
                    {% endfor %}
                {% endif %}
            </div>
            <button class="filmstrip-nav-btn next" aria-label="Scroll filmstrip right">&rsaquo;</button>
        </div>
        {% endif %}
    {% endcapture %}

    <!-- Mobile Image Section (Mobile Only) -->
    {% if display_image %}
    <div class="portfolio-piece-mobile-image lg:hidden">
        <div class="portfolio-piece-visual relative">
            {% if include.carousel_images or include.carousel_inline or has_carousel_folder %}
                <div class="portfolio-image-container relative overflow-hidden aspect-[5/4] cursor-pointer" data-carousel-images='{{ carousel_data | strip }}'>
            {% else %}
                <div class="portfolio-image-container relative overflow-hidden aspect-[5/4] cursor-pointer">
            {% endif %}
                {% if include.image_class %}
                    {% assign img_class = "portfolio-image w-full h-full object-contain transition-all duration-300 " | append: include.image_class %}
                {% else %}
                    {% assign img_class = "portfolio-image w-full h-full object-contain object-center transition-all duration-300" %}
                {% endif %}
                {% assign crop_mode = include.crop_mode | default: "center" %}
                {% if include.image_alt %}
                    {% picture {{ display_image }} 5:4 {{ crop_mode }} --alt {{ include.image_alt }} --img class="{{ img_class }}" %}
                {% elsif include.title %}
                    {% picture {{ display_image }} 5:4 {{ crop_mode }} --alt {{ include.title }} --img class="{{ img_class }}" %}
                {% else %}
                    {% picture {{ display_image }} 5:4 {{ crop_mode }} --img class="{{ img_class }}" %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Two-Column Layout (Desktop lg+ only) -->
    {% assign layout_type = include.layout | default: 'left' %}

    {% if layout_type == 'right' %}
        <!-- RIGHT LAYOUT: Image | Stripe | Title Bar | Image -->
        <div class="portfolio-piece-wrapper hidden lg:!grid lg:grid-cols-[auto_10px_1fr_auto] lg:grid-rows-[auto] lg:gap-x-0 lg:items-stretch lg:max-w-[95vw] lg:w-fit lg:mx-auto mb-[calc(var(--spacing-margin-base)*.5)]">
    {% else %}
        <!-- LEFT LAYOUT: Title Bar | Stripe | Image -->
        <div class="portfolio-piece-wrapper hidden lg:!grid lg:grid-cols-[auto_10px_2fr] lg:grid-rows-[auto] lg:gap-x-0 lg:items-stretch lg:max-w-[95vw] lg:w-fit lg:mx-auto mb-[calc(var(--spacing-margin-base)*.5)]">
    {% endif %}

        {% if layout_type == 'right' %}
            <!-- RIGHT LAYOUT: Image -->
            <div class="portfolio-piece-right mr-5 lg:p-0 flex justify-start items-center">
                {% if display_image %}
                <div class="portfolio-piece-visual relative">
                    {% if include.carousel_images or include.carousel_inline or has_carousel_folder %}
                        <div class="portfolio-image-container relative overflow-hidden max-h-[55vh] h-[55vh] w-auto max-w-[40vw] cursor-pointer" data-carousel-images='{{ carousel_data | strip }}'>
                    {% else %}
                        <div class="portfolio-image-container relative overflow-hidden max-h-[55vh] h-[55vh] w-auto max-w-[40vw] cursor-pointer">
                    {% endif %}
                        {% if include.image_class %}
                            {% assign img_class = "portfolio-image h-full w-auto object-contain transition-all duration-300 " | append: include.image_class %}
                        {% else %}
                            {% assign img_class = "portfolio-image h-full w-auto object-contain object-right transition-all duration-300" %}
                        {% endif %}
                        {% if include.image_alt %}
                            {% picture {{ display_image }} --alt {{ include.image_alt }} --img class="{{ img_class }}" %}
                        {% elsif include.title %}
                            {% picture {{ display_image }} --alt {{ include.title }} --img class="{{ img_class }}" %}
                        {% else %}
                            {% picture {{ display_image }} --img class="{{ img_class }}" %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- RIGHT LAYOUT: Vertical Stripe -->
            <div class="stripe-divider-vertical !border-2 !border-solid !border-light-blue self-stretch"></div>

            <!-- RIGHT LAYOUT: Title Bar and Content -->
            <div class="flex flex-col items-start self-start w-full">
                <!-- Title bar with line extensions -->
                <div class="flex items-baseline w-full">
                    <div class="h-[2px] bg-light-blue grow-4"></div>
                    <div class="lg:px-4 flex-shrink-0">{{ desktop_header }}</div>
                    <div class="h-[2px] bg-light-blue grow-1"></div>
                </div>
                <!-- Content below title bar -->
                <div class="lg:pl-12 lg:pt-4 max-w-[52vw]">
                    {{ content_block }}
                    {{ filmstrip_block }}
                </div>
            </div>
        {% else %}
            <!-- LEFT LAYOUT: Title Bar and Content -->
            <div class="flex flex-col items-end self-start w-full max-w-[52vw] flex-1 ">
                <!-- Title bar with line extensions -->
                <div class="flex items-baseline w-full">
                    <div class="h-[2px] bg-light-blue grow-4"></div>
                    <div class="lg:px-4 flex-shrink-0">{{ desktop_header }}</div>
                    <div class="h-[2px] bg-light-blue grow-1"></div>
                </div>
                <!-- Content below title bar -->
                <div class="lg:pr-12 lg:pt-[calc(var(--spacing-margin-base)*0.5)] max-w-[52vw] flex flex-col h-auto content-around flex-1 gap-[calc(var(--spacing-margin-base)*0.2)]">
                    {{ content_block }}
                    {{ filmstrip_block }}
                </div>
            </div>

            <!-- LEFT LAYOUT: Vertical Stripe -->
            <div class="stripe-divider-vertical !border-2 !border-solid !border-light-blue self-stretch"></div>

            <!-- LEFT LAYOUT: Image -->
            <div class="portfolio-piece-right  lg:p-0 flex justify-end items-center ml-5">
                {% if display_image %}
                <div class="portfolio-piece-visual relative">
                    {% if include.carousel_images or include.carousel_inline or has_carousel_folder %}
                        <div class="portfolio-image-container relative overflow-hidden max-h-[55vh] h-[55vh] w-auto max-w-[40vw] cursor-pointer" data-carousel-images='{{ carousel_data | strip }}'>
                    {% else %}
                        <div class="portfolio-image-container relative overflow-hidden max-h-[55vh] h-[55vh] w-auto max-w-[40vw] cursor-pointer ">
                    {% endif %}
                        {% if include.image_class %}
                            {% assign img_class = "portfolio-image h-full w-auto object-contain transition-all duration-300 " | append: include.image_class %}
                        {% else %}
                            {% assign img_class = "portfolio-image h-full w-auto object-contain object-left transition-all duration-300" %}
                        {% endif %}
                        {% if include.image_alt %}
                            {% picture {{ display_image }} --alt {{ include.image_alt }} --img class="{{ img_class }}" %}
                        {% elsif include.title %}
                            {% picture {{ display_image }} --alt {{ include.title }} --img class="{{ img_class }}" %}
                        {% else %}
                            {% picture {{ display_image }} --img class="{{ img_class }}" %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        {% endif %}
    </div><!-- Close portfolio-piece-wrapper -->

    <!-- Content Section (Mobile Only) -->
    {% if include.content %}
    <div class="portfolio-piece-content lg:hidden ml-margin-base mr-margin-base max-h-0 overflow-hidden transition-all duration-500">
        <div class="prose-invert max-w-none text-left sm:text-justify pt-4">
            {{ include.content | markdownify }}
        </div>
        <div>
            <p class="ml-2"> <span class="text-light-blue hero-text uppercase">Skills:</span> {{ include.skills }}</p> 
        </div>
         
    </div>
    {% endif %}

    <!-- Divider with Toggle Button (Mobile Only) -->
    {% if display_image %}
    <div class="portfolio-divider-container lg:hidden">
        <div class="flex items-center w-full gap-0">
            <div class="stripe-divider flex-1"></div>
            <button class="portfolio-toggle-btn font-barlow px-2 text-light-blue! text-[1rem] uppercase cursor-pointer flex-shrink-0">
                Read More
            </button>
            <div class="stripe-divider flex-1"></div>
        </div>
    </div>
    {% endif %}

    <!-- Gallery Section -->
    {% if include.gallery %}
    <div class="portfolio-piece-gallery mb-6 md:mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for image in include.gallery %}
            <div class="relative overflow-hidden">
                {% picture {{ image.src }} --alt {{ image.alt | default: 'Gallery image' }} --img class="w-full h-auto object-cover" %}
                {% if image.caption %}
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3">
                    <p class="text-sm text-light-blue">{{ image.caption }}</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Meta Information -->
    {% if include.meta %}
    <div class="portfolio-piece-meta border-t border-light-blue/20 pt-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-light-blue/70">
            {% if include.meta.date %}
            <div>
                <span class="text-yellow-400 uppercase tracking-wider">Date:</span>
                <span class="ml-2">{{ include.meta.date }}</span>
            </div>
            {% endif %}
            {% if include.meta.client %}
            <div>
                <span class="text-yellow-400 uppercase tracking-wider">Client:</span>
                <span class="ml-2">{{ include.meta.client }}</span>
            </div>
            {% endif %}
            {% if include.meta.tools %}
            <div>
                <span class="text-yellow-400 uppercase tracking-wider">Tools:</span>
                <span class="ml-2">{{ include.meta.tools }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Call to Action -->
    {% if include.cta %}
    <div class="portfolio-piece-cta mt-6 md:mt-8">
        {% if include.cta.link %}
        <a href="{{ include.cta.link }}"
           class="inline-block text-yellow-400 hero-text text-[clamp(1rem,3cqw,1.5rem)] hover:text-yellow-300 transition-colors">
            {{ include.cta.text | default: "View Project" }}
        </a>
        {% else %}
        <span class="text-yellow-400 hero-text text-[clamp(1rem,3cqw,1.5rem)]">
            {{ include.cta.text }}
        </span>
        {% endif %}
    </div>
    {% endif %}

</article>