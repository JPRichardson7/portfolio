<!-- Portfolio Piece Component -->
<article class="portfolio-piece">

    <!-- Title Section (Mobile Only) -->
    {% if include.title %}
        <header class="portfolio-piece-header flex items-baseline lg:hidden!">
            <div class="w-[calc(var(--spacing-margin-base)*2)] h-[.4cqw] bg-light-blue flex-shrink-0 "></div>
            <div class="flex-shrink-0 px-2">
                <h2 class="hero-text text-light-blue text-[clamp(1rem,5cqw,1.10rem)]! italic tracking-widest">
                    {{ include.title }}
                </h2>
                {% if include.subtitle %}
                    <p class="text-light-blue/80 text-[clamp(1rem,3cqw,1.5rem)] font-light">
                        {{ include.subtitle }}
                    </p>
                {% endif %}
            </div>
            <div class="flex-1 h-[.4cqw] bg-light-blue"></div>
        </header>
    {% endif %}

    <!-- Prepare carousel data before layout split -->
    {% assign has_carousel_folder = false %}
    {% if include.carousel_folder and include.carousel_folder != "" %}
        {% assign has_carousel_folder = true %}
        {% comment %} Auto-discover images from folder {% endcomment %}
        {% assign folder_path = include.carousel_folder | prepend: "/" %}
        {% assign folder_images = site.static_files | where_exp: "file", "file.path contains folder_path" | where_exp: "file", "file.extname == '.jpg' or file.extname == '.jpeg' or file.extname == '.png' or file.extname == '.gif' or file.extname == '.webp'" | sort: "name" %}

        {% comment %} Try to load metadata from _data/projects/[folder-name].yml {% endcomment %}
        {% assign folder_basename = include.carousel_folder | split: "/" | last %}
        {% assign meta_data = site.data.projects[folder_basename] %}
    {% elsif include.carousel_inline %}
        {% comment %} Parse inline format: "img1.jpg|Alt 1|img2.jpg|Alt 2" {% endcomment %}
        {% assign inline_parts = include.carousel_inline | split: '|' %}
    {% endif %}

    <!-- Generate carousel data once for all uses -->
    {% if include.carousel_images or include.carousel_inline or has_carousel_folder %}
        {% if has_carousel_folder %}
            {% capture carousel_data %}[{% for img in folder_images %}{% if forloop.first == false %},{% endif %}{"src":"{{ img.path }}","alt":"{% if meta_data[img.name] %}{{ meta_data[img.name] | escape }}{% else %}{{ img.path | image_description | escape }}{% endif %}"}{% endfor %}]{% endcapture %}
        {% elsif include.carousel_inline %}
            {% capture carousel_data %}[{% for i in (0..10) %}{% assign idx = i | times: 2 %}{% assign src_idx = idx %}{% assign alt_idx = idx | plus: 1 %}{% assign src = inline_parts[src_idx] %}{% assign alt = inline_parts[alt_idx] %}{% if src and src != '' %}{% if i > 0 %},{% endif %}{"src":"/{{ src }}","alt":"{{ alt | escape }}"}{% endif %}{% endfor %}]{% endcapture %}
        {% else %}
            {% capture carousel_data %}[{% for img in include.carousel_images %}{% if forloop.first == false %},{% endif %}{"src":"/{{ img.src }}","alt":"{{ img.alt | escape }}"}{% endfor %}]{% endcapture %}
        {% endif %}
    {% endif %}

    <!-- Reusable blocks for desktop layout -->
    {% capture desktop_header %}
        {% if include.title %}
            <header class="portfolio-piece-header-desktop flex flex-col">
                <h2 class="hero-text text-light-blue text-[clamp(1.2rem,3vw,2rem)]! italic tracking-widest">
                    {{ include.title }}
                </h2>
                {% if include.subtitle %}
                    <p class="text-light-blue/80 text-[clamp(1rem,2vw,1.5rem)]! font-light">
                        {{ include.subtitle }}
                    </p>
                {% endif %}
            </header>
        {% endif %}
    {% endcapture %}

    {% capture content_block %}
        {% if include.content %}
            <div class="prose-invert max-w-none text-left sm:text-justify">
                {{ include.content | markdownify }}
            </div>
        {% endif %}
    {% endcapture %}

    {% capture filmstrip_block %}
        {% if include.carousel_images or include.carousel_inline or has_carousel_folder %}
        <div class="portfolio-filmstrip hidden lg:flex! gap-2 mt-4 overflow-x-auto">
            {% if has_carousel_folder %}
                {% for img in folder_images %}
                <button class="filmstrip-thumb flex-shrink-0 w-30 h-30 overflow-hidden pb-1 border-b-4 border-transparent hover:border-light-blue/50 transition-all cursor-pointer" data-index="{{ forloop.index0 }}">
                    <img src="{{ img.path }}" alt="{% if meta_data[img.name] %}{{ meta_data[img.name] }}{% else %}Thumbnail {{ forloop.index }}{% endif %}" class="w-full h-full object-cover">
                </button>
                {% endfor %}
            {% elsif include.carousel_inline %}
                {% for i in (0..10) %}
                    {% assign idx = i | times: 2 %}
                    {% assign src = inline_parts[idx] %}
                    {% if src and src != '' %}
                    <button class="filmstrip-thumb flex-shrink-0 w-20 h-16 overflow-hidden border-2 border-transparent hover:border-light-blue/50 transition-all cursor-pointer" data-index="{{ i }}">
                        <img src="/{{ src }}" alt="Thumbnail {{ i | plus: 1 }}" class="w-full h-full object-cover">
                    </button>
                    {% endif %}
                {% endfor %}
            {% else %}
                {% for img in include.carousel_images %}
                <button class="filmstrip-thumb flex-shrink-0 w-20 h-16 overflow-hidden border-2 border-transparent hover:border-light-blue/50 transition-all cursor-pointer" data-index="{{ forloop.index0 }}">
                    <img src="/{{ img.src }}" alt="{{ img.alt }}" class="w-full h-full object-cover">
                </button>
                {% endfor %}
            {% endif %}
        </div>
        {% endif %}
    {% endcapture %}

    <!-- Mobile Image Section (Mobile Only) -->
    {% assign display_image = include.image %}
    {% if include.image == "" or include.image == nil %}
        {% if has_carousel_folder and folder_images.size > 0 %}
            {% assign display_image = folder_images[0].path | remove_first: "/assets/img/" | remove_first: "assets/img/" %}
        {% endif %}
    {% endif %}
    {% if display_image %}
    <div class="portfolio-piece-mobile-image lg:hidden">
        <div class="portfolio-piece-visual relative">
            {% if include.carousel_images or include.carousel_inline or has_carousel_folder %}
                <div class="portfolio-image-container relative overflow-hidden aspect-[5/4] cursor-pointer" data-carousel-images='{{ carousel_data | strip }}'>
            {% else %}
                <div class="portfolio-image-container relative overflow-hidden aspect-[5/4] cursor-pointer">
            {% endif %}
                {% if include.image_class %}
                    {% assign img_class = "portfolio-image w-full h-full object-cover transition-all duration-300 " | append: include.image_class %}
                {% else %}
                    {% assign img_class = "portfolio-image w-full h-full object-cover object-center transition-all duration-300" %}
                {% endif %}
                {% if include.object_position %}
                    {% assign inline_style = "object-position: " | append: include.object_position | append: " !important;" %}
                {% else %}
                    {% assign inline_style = "" %}
                {% endif %}
                {% if include.image_alt %}
                    {% if inline_style != "" %}
                        {% picture {{ display_image }} --alt {{ include.image_alt }} --img class="{{ img_class }}" style="{{ inline_style }}" %}
                    {% else %}
                        {% picture {{ display_image }} --alt {{ include.image_alt }} --img class="{{ img_class }}" %}
                    {% endif %}
                {% elsif include.title %}
                    {% if inline_style != "" %}
                        {% picture {{ display_image }} --alt {{ include.title }} --img class="{{ img_class }}" style="{{ inline_style }}" %}
                    {% else %}
                        {% picture {{ display_image }} --alt {{ include.title }} --img class="{{ img_class }}" %}
                    {% endif %}
                {% else %}
                    {% if inline_style != "" %}
                        {% picture {{ display_image }} --img class="{{ img_class }}" style="{{ inline_style }}" %}
                    {% else %}
                        {% picture {{ display_image }} --img class="{{ img_class }}" %}
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Two-Column Layout (Desktop lg+ only) -->
    {% assign layout_type = include.layout | default: 'left' %}

    {% if layout_type == 'right' %}
        <!-- RIGHT LAYOUT: Image | Stripe | Title Bar | Image -->
        <div class="portfolio-piece-wrapper hidden lg:!grid lg:grid-cols-[auto_10px_1fr_auto] lg:grid-rows-[auto] lg:gap-x-0 lg:items-stretch lg:max-w-[95vw] lg:w-fit lg:mx-auto mb-[calc(var(--spacing-margin-base)*.5)]">
    {% else %}
        <!-- LEFT LAYOUT: Title Bar | Stripe | Image -->
        <div class="portfolio-piece-wrapper hidden lg:!grid lg:grid-cols-[auto_10px_2fr] lg:grid-rows-[auto] lg:gap-x-0 lg:items-stretch lg:max-w-[95vw] lg:w-fit lg:mx-auto mb-[calc(var(--spacing-margin-base)*.5)]">
    {% endif %}

        {% if layout_type == 'right' %}
            <!-- RIGHT LAYOUT: Image -->
            <div class="portfolio-piece-right lg:m-0 lg:p-0 flex justify-start items-center">
                {% if display_image %}
                <div class="portfolio-piece-visual relative">
                    {% if include.carousel_images or include.carousel_inline or has_carousel_folder %}
                        <div class="portfolio-image-container relative overflow-hidden max-h-[55vh] h-[55vh] w-auto cursor-pointer" data-carousel-images='{{ carousel_data | strip }}'>
                    {% else %}
                        <div class="portfolio-image-container relative overflow-hidden max-h-[55vh] h-[55vh] w-auto cursor-pointer">
                    {% endif %}
                        {% if include.image_class %}
                            {% assign img_class = "portfolio-image h-full w-auto object-contain transition-all duration-300 " | append: include.image_class %}
                        {% else %}
                            {% assign img_class = "portfolio-image h-full w-auto object-contain object-right transition-all duration-300" %}
                        {% endif %}
                        {% if include.image_alt %}
                            {% picture {{ display_image }} --alt {{ include.image_alt }} --img class="{{ img_class }}" %}
                        {% elsif include.title %}
                            {% picture {{ display_image }} --alt {{ include.title }} --img class="{{ img_class }}" %}
                        {% else %}
                            {% picture {{ display_image }} --img class="{{ img_class }}" %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- RIGHT LAYOUT: Vertical Stripe -->
            <div class="stripe-divider-vertical !border-2 !border-solid !border-light-blue self-stretch"></div>

            <!-- RIGHT LAYOUT: Title Bar and Content -->
            <div class="flex flex-col items-start self-start w-full">
                <!-- Title bar with line extensions -->
                <div class="flex items-baseline w-full">
                    <div class="h-[2px] bg-light-blue grow-4"></div>
                    <div class="lg:px-4 flex-shrink-0">{{ desktop_header }}</div>
                    <div class="h-[2px] bg-light-blue grow-1"></div>
                </div>
                <!-- Content below title bar -->
                <div class="lg:pl-12 lg:pt-4 max-w-[52vw]">
                    {{ content_block }}
                    {{ filmstrip_block }}
                </div>
            </div>
        {% else %}
            <!-- LEFT LAYOUT: Title Bar and Content -->
            <div class="flex flex-col items-end self-start w-full max-w-[52vw] flex-1 ">
                <!-- Title bar with line extensions -->
                <div class="flex items-baseline w-full">
                    <div class="h-[2px] bg-light-blue grow-4"></div>
                    <div class="lg:px-4 flex-shrink-0">{{ desktop_header }}</div>
                    <div class="h-[2px] bg-light-blue grow-1"></div>
                </div>
                <!-- Content below title bar -->
                <div class="lg:pr-12 lg:pt-[calc(var(--spacing-margin-base)*0.5)] max-w-[52vw] flex flex-col h-auto content-around flex-1 gap-[calc(var(--spacing-margin-base)*0.2)]">
                    {{ content_block }}
                    {{ filmstrip_block }}
                </div>
            </div>

            <!-- LEFT LAYOUT: Vertical Stripe -->
            <div class="stripe-divider-vertical !border-2 !border-solid !border-light-blue self-stretch"></div>

            <!-- LEFT LAYOUT: Image -->
            <div class="portfolio-piece-right lg:m-0 lg:p-0 flex justify-end items-center">
                {% if display_image %}
                <div class="portfolio-piece-visual relative">
                    {% if include.carousel_images or include.carousel_inline or has_carousel_folder %}
                        <div class="portfolio-image-container relative overflow-hidden max-h-[55vh] h-[55vh] w-auto cursor-pointer" data-carousel-images='{{ carousel_data | strip }}'>
                    {% else %}
                        <div class="portfolio-image-container relative overflow-hidden max-h-[55vh] h-[55vh] w-auto cursor-pointer">
                    {% endif %}
                        {% if include.image_class %}
                            {% assign img_class = "portfolio-image h-full w-auto object-contain transition-all duration-300 " | append: include.image_class %}
                        {% else %}
                            {% assign img_class = "portfolio-image h-full w-auto object-contain object-left transition-all duration-300" %}
                        {% endif %}
                        {% if include.image_alt %}
                            {% picture {{ display_image }} --alt {{ include.image_alt }} --img class="{{ img_class }}" %}
                        {% elsif include.title %}
                            {% picture {{ display_image }} --alt {{ include.title }} --img class="{{ img_class }}" %}
                        {% else %}
                            {% picture {{ display_image }} --img class="{{ img_class }}" %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        {% endif %}
    </div><!-- Close portfolio-piece-wrapper -->

    <!-- Content Section (Mobile Only) -->
    {% if include.content %}
    <div class="portfolio-piece-content lg:hidden ml-margin-base mr-margin-base max-h-0 overflow-hidden transition-all duration-500">
        <div class="prose-invert max-w-none text-left sm:text-justify pt-4">
            {{ include.content | markdownify }}
        </div>
    </div>
    {% endif %}

    <!-- Divider with Toggle Button (Mobile Only) -->
    {% if display_image %}
    <div class="portfolio-divider-container lg:hidden">
        <div class="flex items-center w-full gap-0">
            <div class="stripe-divider flex-1"></div>
            <button class="portfolio-toggle-btn font-barlow px-2 text-light-blue! text-[1rem] uppercase cursor-pointer flex-shrink-0">
                Read More
            </button>
            <div class="stripe-divider flex-1"></div>
        </div>
    </div>
    {% endif %}

    <!-- Gallery Section -->
    {% if include.gallery %}
    <div class="portfolio-piece-gallery mb-6 md:mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for image in include.gallery %}
            <div class="relative overflow-hidden">
                {% picture {{ image.src }} --alt {{ image.alt | default: 'Gallery image' }} --img class="w-full h-auto object-cover" %}
                {% if image.caption %}
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3">
                    <p class="text-sm text-light-blue">{{ image.caption }}</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Meta Information -->
    {% if include.meta %}
    <div class="portfolio-piece-meta border-t border-light-blue/20 pt-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-light-blue/70">
            {% if include.meta.date %}
            <div>
                <span class="text-yellow-400 uppercase tracking-wider">Date:</span>
                <span class="ml-2">{{ include.meta.date }}</span>
            </div>
            {% endif %}
            {% if include.meta.client %}
            <div>
                <span class="text-yellow-400 uppercase tracking-wider">Client:</span>
                <span class="ml-2">{{ include.meta.client }}</span>
            </div>
            {% endif %}
            {% if include.meta.tools %}
            <div>
                <span class="text-yellow-400 uppercase tracking-wider">Tools:</span>
                <span class="ml-2">{{ include.meta.tools }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Call to Action -->
    {% if include.cta %}
    <div class="portfolio-piece-cta mt-6 md:mt-8">
        {% if include.cta.link %}
        <a href="{{ include.cta.link }}"
           class="inline-block text-yellow-400 hero-text text-[clamp(1rem,3cqw,1.5rem)] hover:text-yellow-300 transition-colors">
            {{ include.cta.text | default: "View Project" }}
        </a>
        {% else %}
        <span class="text-yellow-400 hero-text text-[clamp(1rem,3cqw,1.5rem)]">
            {{ include.cta.text }}
        </span>
        {% endif %}
    </div>
    {% endif %}

</article>